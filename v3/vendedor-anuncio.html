<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Anunciar Aparelho | RePhone</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --dark: #0f172a; --green: #16a34a; --bg: #f8fafc; --muted: #64748b; }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Inter', sans-serif; }
        body { background: var(--bg); padding: 20px; color: var(--dark); }

        .container { max-width: 500px; margin: 0 auto; display: none; }
        h1 { font-size: 24px; font-weight: 900; margin-bottom: 20px; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 11px; font-weight: 800; text-transform: uppercase; color: var(--muted); margin-bottom: 5px; }
        
        input, select, textarea { 
            width: 100%; padding: 15px; border-radius: 15px; border: 1px solid #e2e8f0; 
            background: white; font-size: 15px; outline: none; font-family: inherit;
        }
        
        input[readonly] { background: #f1f5f9; color: var(--muted); cursor: not-allowed; }

        .photo-upload {
            width: 100%; aspect-ratio: 16/9; background: #f1f5f9; border: 2px dashed #cbd5e1;
            border-radius: 20px; display: flex; flex-direction: column; align-items: center;
            justify-content: center; cursor: pointer; overflow: hidden; position: relative;
        }
        .photo-upload img { width: 100%; height: 100%; object-fit: contain; }
        #fileInput { display: none; }

        .btn-save { 
            width: 100%; background: var(--green); color: white; border: none; 
            padding: 20px; border-radius: 18px; font-weight: 800; font-size: 16px; 
            cursor: pointer; margin-top: 20px;
        }
        .loc-info { font-size: 12px; color: var(--green); font-weight: 700; display: block; margin-top: 5px; }
    </style>
</head>
<body>

    <div id="loading" style="text-align: center; margin-top: 50px; font-weight: 800; color: var(--muted);">VERIFICANDO ACESSO...</div>

    <div class="container" id="app">
        <h1>Novo An√∫ncio</h1>

        <div class="form-group">
            <label>Foto do Aparelho</label>
            <div class="photo-upload" onclick="document.getElementById('fileInput').click()">
                <img id="preview" style="display:none;">
                <div id="uploadPlaceholder">
                    <span style="font-size: 30px;">üì∏</span>
                    <span style="font-size: 12px; font-weight: 700; color: #64748b;">Tirar ou Anexar</span>
                </div>
            </div>
            <input type="file" id="fileInput" accept="image/*" onchange="handleFile(event)">
        </div>

        <div class="form-group">
            <label>Seu WhatsApp (Autom√°tico)</label>
            <input type="text" id="whatsapp" readonly placeholder="Carregando...">
        </div>

        <div class="form-group">
            <label>Localiza√ß√£o Detectada</label>
            <input type="text" id="cidade" placeholder="Buscando cidade..." readonly>
            <span class="loc-info">üìç Cidade capturada automaticamente</span>
        </div>

        <div class="form-group">
            <label>Marca</label>
            <select id="marca"><option>Apple</option><option>Samsung</option></select>
        </div>

        <div class="form-group">
            <label>Modelo</label>
            <input type="text" id="modelo" placeholder="Ex: iPhone 13 Pro Max">
        </div>

        <div class="form-group">
            <label>Cor</label>
            <input type="text" id="cor" placeholder="Ex: Verde Alpino">
        </div>

        <div class="form-group">
            <label>Capacidade</label>
            <select id="capacidade">
                <option>128GB</option><option>256GB</option><option>512GB</option><option>1TB</option>
            </select>
        </div>

        <div class="form-group">
            <label>Condi√ß√£o</label>
            <select id="condicao">
                <option>Novo</option><option>Lacrado</option><option>Vitrine</option><option>Usado</option>
            </select>
        </div>

        <div class="form-group">
            <label>Estado</label>
            <select id="estado">
                <option>Excelente</option><option>√ìtimo</option><option>Bom</option><option>Razo√°vel</option>
            </select>
        </div>

        <div class="form-group">
            <label>Sa√∫de da Bateria (%)</label>
            <input type="number" id="bateria" placeholder="Ex: 95">
        </div>

        <div class="form-group">
            <label>Pre√ßo Sugerido (R$)</label>
            <input type="number" id="preco" placeholder="Ex: 3800">
        </div>

        <div class="form-group">
            <label>Garantia</label>
            <input type="text" id="garantia" placeholder="Ex: 6 meses">
        </div>

        <div class="form-group">
            <label>Descri√ß√£o do An√∫ncio</label>
            <textarea id="descricao" rows="4" placeholder="Conte detalhes sobre o estado do aparelho, riscos ou acess√≥rios inclusos..."></textarea>
        </div>

        <button class="btn-save" id="btnSubmit" onclick="salvarAnuncio()">PUBLICAR NO RADAR</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyBiN8FqX8UZeyAh1cG2GHZtQWiQH0xPBV4", 
            authDomain: "rephone-a0a80.firebaseapp.com", 
            projectId: "rephone-a0a80", 
            storageBucket: "rephone-a0a80.firebasestorage.app", 
            appId: "1:431497247030:web:a943715e4acc04b8995b97" 
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const IMGBB_API_KEY = "a4405be3b982f9aad88589728a3d949c";
        let userLogado = null;
        let fotoArquivo = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) { 
                userLogado = user; 
                
                // Buscar WhatsApp do perfil do vendedor
                try {
             const userDoc = await getDoc(doc(db, "vendedores", user.uid));
if (userDoc.exists()) {
    // Aqui estava o erro: trocamos .whatsapp por .zap que √© como est√° no seu print
    const numeroZap = userDoc.data().zap; 
    document.getElementById('whatsapp').value = numeroZap || "N√£o cadastrado";
                    }
                } catch (e) { console.error("Erro ao buscar perfil", e); }

                document.getElementById('loading').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                obterCidade();
            } else { 
                window.location.href = 'vendedor-login.html'; 
            }
        });

        async function obterCidade() {
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${pos.coords.latitude}&lon=${pos.coords.longitude}&format=json`);
                const data = await res.json();
                document.getElementById('cidade').value = data.address.city || data.address.town || "Local Indefinido";
            });
        }

        window.handleFile = (event) => {
            fotoArquivo = event.target.files[0];
            if (fotoArquivo) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('preview').src = e.target.result;
                    document.getElementById('preview').style.display = 'block';
                    document.getElementById('uploadPlaceholder').style.display = 'none';
                }
                reader.readAsDataURL(fotoArquivo);
            }
        };

        window.salvarAnuncio = async () => {
            if(!fotoArquivo) return alert("Adicione uma foto!");
            const btn = document.getElementById('btnSubmit');
            btn.disabled = true; btn.innerText = "SUBINDO IMAGEM...";

            try {
                const formData = new FormData();
                formData.append("image", fotoArquivo);
                const resImg = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData });
                const dataImg = await resImg.json();
                const urlFinal = dataImg.data.url;

                await addDoc(collection(db, "anuncios"), {
                    vendedorId: userLogado.uid,
                    marca: document.getElementById('marca').value,
                    modelo: document.getElementById('modelo').value,
                    cor: document.getElementById('cor').value,
                    capacidade: document.getElementById('capacidade').value,
                    condicao: document.getElementById('condicao').value,
                    estado: document.getElementById('estado').value,
                    bateria: document.getElementById('bateria').value,
                    preco: document.getElementById('preco').value,
                    cidade: document.getElementById('cidade').value,
                    garantia: document.getElementById('garantia').value,
                    descricao: document.getElementById('descricao').value,
                    whatsapp: document.getElementById('whatsapp').value,
                    fotos: [urlFinal],
                    status: "aprovado",
                    tipoVendedor: "particular",
                    dataCriacao: new Date()
                });

                alert("An√∫ncio publicado!");
                window.location.href = 'index.html';
            } catch (e) {
                alert("Erro ao publicar.");
                btn.disabled = false; btn.innerText = "PUBLICAR NO RADAR";
            }
        };
    </script>
</body>
</html>
