<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RePhone | Radar Aracruz</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
</head>
<body>

    <header class="app-header">
        <div class="brand"><h1>RePhone</h1></div>
        <button onclick="window.location.href='vendedor.html'" class="btn-vender-top">Vender +</button>
    </header>

    <div class="search-container">
        <div class="rp-card-search">
            <input type="text" id="modelInput" placeholder="Qual iPhone voc√™ busca?">
            <button id="btnSearch" class="btn-match-trigger">ATIVAR RADAR RP MATCH</button>
        </div>
    </div>

    <div class="stories-filters">
        <div class="story-item active"><span>üì±</span><small>Todos</small></div>
        <div class="story-item"><span>üìç</span><small>Perto</small></div>
        <div class="story-item"><span>üíé</span><small>Premium</small></div>
    </div>

    <main id="offersGrid" class="feed-grid">
        <div class="loading-state">Iniciando radar em Aracruz...</div>
    </main>

    <div id="matchBar" class="match-panel">
        <div class="drag-handle"></div>
        <h3 id="matchTitle" style="font-size: 24px; font-weight: 900;"></h3>
        <p id="matchDist" style="color: #16a34a; font-weight: 700; margin-bottom: 15px;"></p>
        
        <div id="matchSpecs" class="specs-mini-grid" style="display: flex; gap: 10px; margin-bottom: 20px;">
            </div>

        <button id="btnZap" class="btn-primary" style="width: 100%; padding: 18px; font-size: 16px;">
            CONVERSAR NO WHATSAPP
        </button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getFirestore, collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBiN8FqX8UZeyAh1cG2GHZtQWiQH0xPBV4",
            authDomain: "rephone-a0a80.firebaseapp.com",
            projectId: "rephone-a0a80",
            storageBucket: "rephone-a0a80.firebasestorage.app",
            messagingSenderId: "431497247030",
            appId: "1:431497247030:web:a943715e4acc04b8995b97",
            measurementId: "G-LHRJ19C0CW"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let userLoc = null;

        // Captura localiza√ß√£o do comprador para o c√°lculo de dist√¢ncia
        navigator.geolocation.getCurrentPosition(pos => {
            userLoc = pos.coords;
            carregarAnuncios(); // Recarrega com dist√¢ncias reais
        }, () => carregarAnuncios());

        function calcDist(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2-lat1) * Math.PI/180;
            const dLon = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return (R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))).toFixed(1);
        }

        function carregarAnuncios() {
            // BUSCA APENAS AN√öNCIOS APROVADOS PELO ADMIN
            const q = query(collection(db, "anuncios"), where("status", "==", "aprovado"));
            
            onSnapshot(q, (snapshot) => {
                const grid = document.getElementById('offersGrid');
                grid.innerHTML = "";

                if (snapshot.empty) {
                    grid.innerHTML = "<p style='text-align:center; padding:40px; color:#64748b;'>Nenhum iPhone no radar de Aracruz no momento.</p>";
                    return;
                }

                snapshot.forEach((adDoc) => {
                    const ad = adDoc.data();
                    const d = userLoc ? calcDist(userLoc.latitude, userLoc.longitude, ad.lat, ad.lng) : "?";
                    
                    const card = document.createElement('div');
                    card.className = 'card-item';
                    card.style = "background:white; border-radius:20px; overflow:hidden; margin-bottom:20px; border:1px solid #f1f5f9; padding:15px;";
                    card.onclick = () => abrirMatch(ad, d);
                    
                    card.innerHTML = `
                        <img src="${ad.fotos[0]}" style="width:100%; height:220px; object-fit:contain; background:#f8fafc; border-radius:12px;">
                        <h4 style="margin:10px 0 5px">${ad.modelo}</h4>
                        <div style="display:flex; justify-content:space-between; align-items:center">
                            <span style="color:#16a34a; font-weight:900">R$ ${ad.preco}</span>
                            <small style="color:#64748b">üìç ${d} km</small>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            });
        }

        window.abrirMatch = (ad, dist) => {
            document.getElementById('matchTitle').innerText = ad.modelo;
            document.getElementById('matchDist').innerText = `üìç Apenas ${dist} km de voc√™ em Aracruz`;
            document.getElementById('matchSpecs').innerHTML = `
                <span class='tag-spec'>üîã ${ad.bateria}</span>
                <span class='tag-spec'>‚ú® ${ad.condicao}</span>
            `;
            
            document.getElementById('btnZap').onclick = () => {
                const msg = encodeURIComponent(`Ol√°! Vi o ${ad.modelo} no Radar RePhone e gostaria de mais informa√ß√µes.`);
                window.open(`https://wa.me/5527999999999?text=${msg}`); // Coloque seu n√∫mero aqui
            };

            document.getElementById('matchBar').classList.add('show');
        };

        document.getElementById('btnSearch').onclick = carregarAnuncios;

    </script>

    <style>
        /* Ajustes r√°pidos de CSS para o Radar */
        .feed-grid { padding: 20px; padding-bottom: 100px; }
        .tag-spec { background: #f1f5f9; padding: 8px 12px; border-radius: 10px; font-weight: 700; font-size: 13px; }
        .match-panel { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-radius: 30px 30px 0 0; padding: 25px; transform: translateY(110%); transition: 0.5s cubic-bezier(0, 1, 0.5, 1); z-index: 2000; box-shadow: 0 -10px 40px rgba(0,0,0,0.1); }
        .match-panel.show { transform: translateY(0); }
        .drag-handle { width: 40px; height: 5px; background: #e2e8f0; border-radius: 10px; margin: 0 auto 15px; }
        .btn-vender-top { background: #0f172a; color: white; border: none; padding: 8px 15px; border-radius: 10px; font-weight: 700; cursor: pointer; }
    </style>
</body>
</html>
