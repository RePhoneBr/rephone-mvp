<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Anunciar | RePhone</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --dark: #0f172a; --green: #16a34a; --bg: #f8fafc; --muted: #64748b; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--dark); padding: 15px 15px 120px 15px; }

        .card { background: white; padding: 25px; border-radius: 30px; width: 100%; max-width: 500px; margin: 0 auto; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        
        h2 { font-weight: 900; font-size: 24px; letter-spacing: -1px; margin-bottom: 5px; }
        .vendedor-info { display: flex; justify-content: space-between; align-items: center; background: #f1f5f9; padding: 10px 15px; border-radius: 12px; margin-bottom: 20px; font-size: 11px; font-weight: 700; }

        label { display: block; font-size: 10px; font-weight: 800; color: var(--muted); text-transform: uppercase; margin: 15px 0 6px 5px; }
        input, select, textarea { width: 100%; padding: 14px; border-radius: 14px; border: 1px solid #e2e8f0; font-size: 15px; background: #fff; color: var(--dark); }
        textarea { resize: none; height: 80px; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        /* Termo de Responsabilidade */
        .termo-box { background: #fffef0; border: 1px solid #fde68a; padding: 15px; border-radius: 18px; margin-top: 25px; font-size: 12px; line-height: 1.5; color: #92400e; }
        .check-group { display: flex; align-items: center; gap: 10px; margin-top: 10px; font-weight: 800; cursor: pointer; }
        .check-group input { width: 22px; height: 22px; }

        #btnPublicar { width: 100%; background: var(--dark); color: white; padding: 18px; border-radius: 18px; border: none; font-weight: 900; font-size: 16px; margin-top: 20px; box-shadow: 0 10px 20px rgba(15, 23, 42, 0.2); }

        /* Barra de Navega√ß√£o */
        .nav-bottom { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: var(--dark); display: flex; justify-content: space-around; padding: 15px; border-radius: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); z-index: 1000; }
        .nav-item { color: #94a3b8; text-decoration: none; font-size: 10px; font-weight: 800; text-align: center; text-transform: uppercase; }
        .nav-item.active { color: var(--green); }
        .nav-item span { display: block; font-size: 18px; margin-bottom: 4px; }
    </style>
</head>
<body>

    <div class="card">
        <div id="loading">Sincronizando perfil...</div>

        <div id="formConteudo" style="display:none;">
            <div class="vendedor-info">
                <span>VENDEDOR: <b id="nomeVend">...</b></span>
                <span id="statusGPS" style="color: var(--green);">üìç LOCALIZANDO...</span>
            </div>

            <h2>Novo An√∫ncio</h2>
            <p style="color:var(--muted); font-size:13px; margin-bottom:10px;">Preencha todos os detalhes para o Match.</p>

            <form id="formAnuncio">
                <div class="grid-2">
                    <div>
                        <label>Marca</label>
                        <select id="pMarca">
                            <option>Apple</option><option>Samsung</option><option>Xiaomi</option><option>Outros</option>
                        </select>
                    </div>
                    <div>
                        <label>Tipo de Vendedor</label>
                        <select id="pTipo">
                            <option value="Particular">Particular</option>
                            <option value="Lojista">Lojista</option>
                        </select>
                    </div>
                </div>

                <label>Modelo do Aparelho</label>
                <input type="text" id="pModelo" placeholder="Ex: iPhone 14 Pro Max" required>

                <div class="grid-2">
                    <div>
                        <label>Capacidade</label>
                        <select id="pCapacidade">
                            <option>64GB</option><option>128GB</option><option>256GB</option><option>512GB</option><option>1TB</option>
                        </select>
                    </div>
                    <div>
                        <label>Bateria (%)</label>
                        <input type="number" id="pBateria" placeholder="90" required>
                    </div>
                </div>

                <div class="grid-2">
                    <div>
                        <label>Pre√ßo (R$)</label>
                        <input type="number" id="pPreco" placeholder="4500" required>
                    </div>
                    <div>
                        <label>Condi√ß√£o</label>
                        <select id="pCondicao">
                            <option>Excelente / Novo</option><option>Bom (Sinais de uso)</option><option>Vitrine</option>
                        </select>
                    </div>
                </div>

                <label>Descri√ß√£o Opcional</label>
                <textarea id="pDescricao" placeholder="Fale sobre garantia, nota fiscal, se tem caixa ou acess√≥rios..."></textarea>

                <label>Fotos (At√© 5 fotos)</label>
                <input type="file" id="pFotos" accept="image/*" multiple required>

                <div class="termo-box">
                    <strong>DECLARA√á√ÉO DE PROCED√äNCIA</strong><br>
                    Eu, <span id="declaranteNome">...</span>, declaro que este aparelho √© de origem l√≠cita e que as fotos s√£o reais. Localiza√ß√£o registrada para c√°lculo de dist√¢ncia.
                    <label class="check-group">
                        <input type="checkbox" id="aceitoTermo" required>
                        <span>CONCORDO E ACEITO</span>
                    </label>
                </div>

                <button type="submit" id="btnPublicar">PUBLICAR NO RADAR</button>
            </form>
        </div>
    </div>

    <nav class="nav-bottom">
        <a href="index.html" class="nav-item"><span>üè†</span>Radar</a>
        <a href="vendedor.html" class="nav-item active"><span>‚ûï</span>Anunciar</a>
        <a href="dashboard-vendedor.html" class="nav-item"><span>üìä</span>Meus Docs</a>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyBiN8FqX8UZeyAh1cG2GHZtQWiQH0xPBV4", authDomain: "rephone-a0a80.firebaseapp.com", projectId: "rephone-a0a80", storageBucket: "rephone-a0a80.firebasestorage.app", messagingSenderId: "431497247030", appId: "1:431497247030:web:a943715e4acc04b8995b97" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const IMGBB_KEY = "a4405be3b982f9aad88589728a3d949c";

        let dadosVendedor = null;

        onAuthStateChanged(auth, async (user) => {
            if (!user) { window.location.href = "vendedor-login.html"; return; }
            const docSnap = await getDoc(doc(db, "vendedores", user.uid));
            if (docSnap.exists()) {
                dadosVendedor = docSnap.data();
                document.getElementById('nomeVend').innerText = dadosVendedor.nome;
                document.getElementById('declaranteNome').innerText = dadosVendedor.nome;
                document.getElementById('statusGPS').innerText = dadosVendedor.coords ? "üìç GPS OK" : "üìç S/ LOCALIZA√á√ÉO";
                document.getElementById('loading').style.display = "none";
                document.getElementById('formConteudo').style.display = "block";
            }
        });

        document.getElementById('formAnuncio').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnPublicar');
            btn.innerText = "SUBINDO IMAGENS..."; btn.disabled = true;

            const files = document.getElementById('pFotos').files;
            const urls = [];
            
            try {
                for (let file of files) {
                    const fd = new FormData(); fd.append("image", file);
                    const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: "POST", body: fd });
                    const d = await res.json(); 
                    if(d.success) urls.push(d.data.url);
                }

                await addDoc(collection(db, "anuncios"), {
                    uid: auth.currentUser.uid,
                    vendedorNome: dadosVendedor.nome,
                    whatsapp: dadosVendedor.zap,
                    cidade: dadosVendedor.cidade,
                    coords: dadosVendedor.coords, // A localiza√ß√£o vem do perfil do vendedor
                    marca: document.getElementById('pMarca').value,
                    tipo: document.getElementById('pTipo').value,
                    modelo: document.getElementById('pModelo').value,
                    capacidade: document.getElementById('pCapacidade').value,
                    condicao: document.getElementById('pCondicao').value,
                    bateria: document.getElementById('pBateria').value,
                    preco: document.getElementById('pPreco').value,
                    descricao: document.getElementById('pDescricao').value,
                    fotos: urls,
                    status: "aprovado",
                    data: new Date()
                });

                alert("Match pronto! Aparelho publicado com sucesso.");
                document.getElementById('formAnuncio').reset();
                btn.innerText = "PUBLICAR OUTRO";
                btn.disabled = false;
                window.scrollTo({ top: 0, behavior: 'smooth' });

            } catch (err) {
                alert("Erro: " + err.message);
                btn.disabled = false;
            }
        };
    </script>
</body>
</html>
