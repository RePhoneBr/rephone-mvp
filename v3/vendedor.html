<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Anunciar Aparelho | RePhone</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --dark: #0f172a; --green: #16a34a; --bg: #f8fafc; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); padding: 20px; color: var(--dark); }
        .card { background: white; padding: 25px; border-radius: 25px; max-width: 550px; margin: 0 auto; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        
        .vendedor-tag { background: #f1f5f9; padding: 12px; border-radius: 12px; margin-bottom: 20px; font-size: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #e2e8f0; }
        
        label { display: block; font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; margin: 15px 0 5px 5px; }
        input, select, textarea { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #e2e8f0; background: #fff; outline: none; font-size: 14px; }
        
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        
        /* TERMO DE RESPONSABILIDADE */
        .termo-box { 
            background: #fffef0; 
            border: 1px solid #fde68a; 
            padding: 15px; 
            border-radius: 15px; 
            margin-top: 25px; 
            font-size: 11px; 
            line-height: 1.4; 
            color: #92400e; 
        }
        .checkbox-container { display: flex; align-items: flex-start; gap: 10px; margin-top: 10px; cursor: pointer; }
        .checkbox-container input { width: 18px; height: 18px; margin: 0; cursor: pointer; }

        button { width: 100%; background: var(--dark); color: white; padding: 18px; border-radius: 15px; border: none; font-weight: 800; cursor: pointer; margin-top: 20px; }
        button:disabled { background: #cbd5e1; }
    </style>
</head>
<body>

    <div class="card">
        <div id="loading">Sincronizando perfil...</div>

        <div id="formConteudo" style="display:none;">
            <div class="vendedor-tag">
                <span>Vendedor: <b id="displayNome">...</b></span>
                <span id="displayLocal" style="color:var(--green); font-weight:bold;">üìç Localiza√ß√£o Ativa</span>
            </div>

            <h2 style="font-weight:900;">Detalhes do Aparelho</h2>
            
            <form id="formAnuncio">
                <div class="grid-3">
                    <div>
                        <label>Marca</label>
                        <input type="text" id="pMarca" placeholder="Ex: Apple" required>
                    </div>
                    <div style="grid-column: span 2;">
                        <label>Modelo exato</label>
                        <input type="text" id="pModelo" placeholder="Ex: iPhone 14 Pro Max" required>
                    </div>
                </div>

                <div class="grid-3">
                    <div>
                        <label>Cor</label>
                        <input type="text" id="pCor" placeholder="Ex: Tit√¢nio" required>
                    </div>
                    <div>
                        <label>Capacidade</label>
                        <select id="pCapacidade">
                            <option>64GB</option><option>128GB</option><option>256GB</option>
                            <option>512GB</option><option>1TB</option>
                        </select>
                    </div>
                    <div>
                        <label>Sa√∫de Bateria</label>
                        <input type="number" id="pBateria" placeholder="%" required>
                    </div>
                </div>

                <label>Condi√ß√£o do Aparelho</label>
                <select id="pCondicao">
                    <option value="Usado">üì± Usado (Original)</option>
                    <option value="Novo">‚ú® Novo (Lacrado)</option>
                    <option value="Recondicionado">üîß Recondicionado (Grade A)</option>
                </select>

                <label>Pre√ßo de Venda (R$)</label>
                <input type="number" id="pPreco" placeholder="Ex: 4500" required>

                <label>Descri√ß√£o Complementar</label>
                <textarea id="pDesc" rows="2" placeholder="Ex: √önico dono, com NF e caixa..."></textarea>

                <label>Fotos Reais do Produto</label>
                <input type="file" id="pFotos" accept="image/*" multiple required>

                <div class="termo-box">
                    <strong>DECLARA√á√ÉO DE POSSE E RESPONSABILIDADE</strong><br>
                    Eu, <span id="termoNome" style="text-decoration: underline; font-weight:bold;"></span>, 
                    declaro para os devidos fins que o aparelho acima descrito √© de minha propriedade e proced√™ncia l√≠cita. 
                    Assumo total responsabilidade civil e criminal sobre a veracidade das informa√ß√µes e sobre qualquer evento futuro relacionado a este an√∫ncio. 
                    Estou ciente que minha localiza√ß√£o (<span id="termoGPS"></span>) foi registrada para fins de seguran√ßa da plataforma RePhone.

                    <label class="checkbox-container">
                        <input type="checkbox" id="aceitoTermo" required>
                        <span>Li e concordo com os termos de posse e responsabilidade.</span>
                    </label>
                </div>

                <button type="submit" id="btnPublicar">PUBLICAR NO RADAR</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyBiN8FqX8UZeyAh1cG2GHZtQWiQH0xPBV4", authDomain: "rephone-a0a80.firebaseapp.com", projectId: "rephone-a0a80", storageBucket: "rephone-a0a80.firebasestorage.app", messagingSenderId: "431497247030", appId: "1:431497247030:web:a943715e4acc04b8995b97" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const IMGBB_KEY = "a4405be3b982f9aad88589728a3d949c";

        let dadosVendedor = null;

        onAuthStateChanged(auth, async (user) => {
            if (!user) { window.location.href = "vendedor-login.html"; }
            else {
                const snap = await getDoc(doc(db, "vendedores", user.uid));
                if (snap.exists()) {
                    dadosVendedor = snap.data();
                    document.getElementById('displayNome').innerText = dadosVendedor.nome;
                    document.getElementById('termoNome').innerText = dadosVendedor.nome;
                    document.getElementById('termoGPS').innerText = dadosVendedor.coords;
                    document.getElementById('loading').style.display = "none";
                    document.getElementById('formConteudo').style.display = "block";
                }
            }
        });

        document.getElementById('formAnuncio').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnPublicar');
            btn.innerText = "VALIDANDO E ENVIANDO...";
            btn.disabled = true;

            // Upload ImgBB
            const files = document.getElementById('pFotos').files;
            const urls = [];
            for (let file of files) {
                const fd = new FormData(); fd.append("image", file);
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: "POST", body: fd });
                const d = await res.json(); urls.push(d.data.url);
            }

            try {
                await addDoc(collection(db, "anuncios"), {
                    uid: auth.currentUser.uid,
                    vendedorNome: dadosVendedor.nome,
                    whatsapp: dadosVendedor.zap,
                    cidade: dadosVendedor.cidade,
                    coordsOrigem: dadosVendedor.coords,
                    tipoVendedor: dadosVendedor.tipo,
                    marca: document.getElementById('pMarca').value,
                    modelo: document.getElementById('pModelo').value,
                    cor: document.getElementById('pCor').value,
                    capacidade: document.getElementById('pCapacidade').value,
                    condicao: document.getElementById('pCondicao').value,
                    bateria: document.getElementById('pBateria').value,
                    preco: document.getElementById('pPreco').value,
                    descricao: document.getElementById('pDesc').value,
                    fotos: urls,
                    termoAceito: true,
                    dataAnuncio: new Date(),
                    status: "pendente"
                });
                alert("An√∫ncio publicado! Aguarde a modera√ß√£o.");
                window.location.href = "dashboard-vendedor.html";
            } catch (err) {
                alert("Erro ao salvar. Tente novamente.");
                btn.disabled = false;
            }
        };
    </script>
</body>
</html>
